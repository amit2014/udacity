Delinquency at Peer-to-Peer Lender Prosper.com
========================================================
**by Jason Carter**

----

## Introduction

**What is Prosper**

Prosper, or Prosper Marketplace, is a leader in the online peer-to-peer lending industry. Borrowers create profiles and listings on [Prosper.com](https://prosper.com) request personal loans and investors, either individuals or institutions, view the listing (borrower's loan request) and decide how much to lend the borrower towards the loan. 

Interest rates are typically lower for the borrower than going to a financial institution, such as a bank. And multiple investors can contribute to one borrower's loan request, limiting the overall risk impact of the borrower defaulting on the loan for any one investor.

**Why Prosper Loan Data**

I've personally never used peer-to-peer lending, as a borrower or investor, but I find the idea quite intriguing from a borrower and an investor standpoint. Lower interest rates and the ability to get a loan for "small" items is the obvious pro for borrowers. But for an investor portfolio diversification and higher or less risky investment only holds true if borrower's don't default on their loans. So what are the deliquincy rates? Is there any main contributing factor? Is there any coorelation between where someone lives, their income, the purpose of their loan and defaulting on their loan? Deliquincies and their coorelation at Prosper.com is what we'll be exploring.

> Delinquent is the failure to accomplish what is required by law or duty, such as the failure to make a required payment or to perform a certain action.
>
> The term delinquent commonly refers to a situation where a borrower is late or overdue on a payment, such as income taxes, a mortgage, automobile loan or credit card account. 
>
> -- [Investopedia](http://www.investopedia.com/terms/d/delinquent.asp)


## Data Overview
The Prosper loan dataset was provided by Udacity as part of their [Data Set Options](https://docs.google.com/document/d/1qEcwltBMlRYZT-l699-71TzInWfk4W9q5rTCSvDVMpc/pub?embedded=true)

From Udacity

*This data set contains 113,937 loans with 81 variables on each loan, including loan amount, borrower rate (or interest rate), current loan status, borrower income, borrower employment status, borrower credit history, and the latest payment information.*

Dataset was last updated 03/11/2014

### Process
Overall plan on data exploration - say something here

1. load libraries
2. load data
3. summary look
4. univariate plot+analysis
5. bivariate plot+analysis
5. multivariate plot+analysis
6. final plots
7. reflection

With 81 variables, it would be useful to indicate which ones you'll send time looking at. 
Performed an initial review of all [variables definitions](https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit) and determined a list of 15-ish variables which will be required either directly or indirectly for the exploration.

#### Main Features of Interest

After reviewing the long list of variables, and thinking of all of the different paths of investigation, I've decided to narrow my focus of investigation around deliquencies and their correlations. To this end, the main features of interest are:

* **Term**: The length of the loan expressed in months.
* **LoanStatus**: The current status of the loan.
    - Cancelled
    - Chargedoff
    - Completed
    - Current
    - Defaulted
    - FinalPaymentInProgress
    - PastDue (the PastDue status will be accompanied by a delinquency bucket)
* **BorrowerState**: The two letter abbreviation of the state of the address of the borrower at the time the Listing was created.
* **ListingCategory**: The category of the listing that the borrower selected when posting their listing.
    - 0 - Not Available
    - 1 - Debt Consolidation
    - 2 - Home Improvement
    - 3 - Business
    - 4 - Personal Loan
    - 5 - Student Use
    - 6 - Auto
    - 7- Other
    - 8 - Baby&Adoption
    - 9 - Boat
    - 10 - Cosmetic Procedure
    - 11 - Engagement Ring
    - 12 - Green Loans
    - 13 - Household Expenses
    - 14 - Large Purchases
    - 15 - Medical/Dental
    - 16 - Motorcycle
    - 17 - RV
    - 18 - Taxes
    - 19 - Vacation
    - 20 - Wedding Loans
* **CreditScoreRangeLower**: The lower value representing the range of the borrower's credit score as provided by a consumer credit rating agency.
* **CreditScoreRangeUpper**: The upper value representing the range of the borrower's credit score as provided by a consumer credit rating agency. 
* **BankcardUtilization**: The percentage of available revolving credit that is utilized at the time the credit profile was pulled.
* **IncomeRange**: The income range of the borrower at the time the listing was created.
* **TotalProsperLoans**: Number of Prosper loans the borrower at the time they created this listing. This value will be null if the borrower had no prior loans. 
* **LoanOriginalAmount**: The origination amount of the loan.
* **Investors**: The number of investors that funded the loan.

#### Supporting Features
Supporting features...

* **ListingCreationDate**: The date the listing was created.
* **Occupation**: The Occupation selected by the Borrower at the time they created the listing.
* **IsBorrowerHomeowner**: A Borrower will be classified as a homowner if they have a mortgage on their credit profile or provide documentation confirming they are a homeowner.
* **BorrowerAPR**: The Borrower's Annual Percentage Rate (APR) for the loan.
* **BorrowerRate**: The Borrower's interest rate for this loan. 
* **Recommendations**: Number of recommendations the borrower had at the time the listing was created.
* **DebtToIncomeRatio**:
* **StatedMonthlyIncome**:


```{r echo=FALSE, message=FALSE, warning=FALSE, Packages}
#TODO: include "install.packages???" 

# Required for plots and manipulation
library(ggplot2) 
library(dplyr)
library(maps)
library(mapproj)
library(gridExtra)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}
# Load the Data
pld <- read.csv("prosperLoanData.csv")
```

## Exploratory Analysis
### Univariate analysis 
First, I want to review some basics values and descriptive statistics of the dataset. This is for two reasons, 1) to verify some values put forward by Udacity, such as the 81 variables and 113,937 observations. And 2) to determine if there is anything "weird" or stands out about the data which I may want to dive deeper into. Although I have a general direction, i.e deliquencies and their correlations, if something as or more interesting pops up from the descriptive stats, I'll take a peek in that direction as well. 

Lets take a look at the dataset and verify the dimensions
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Investigate dataset dimensions
dim(pld)
```

Now, I setup the new data frame by keeping only the main and support variables.

Column "ListingCategory" is actually labelled "ListingCategory..numeric." as its column value, numeric, is mapped to a string one word description.

```{r echo=FALSE, message=FALSE, warning=FALSE, Create_Dataframe_Subsets}
# Review column name to fix subset() issue
names(pld[17])

# List of variables to keep
colsToKeep <- c("Term","LoanStatus","BorrowerState","ListingCategory..numeric.",
               "CreditScoreRangeLower","CreditScoreRangeUpper","BankcardUtilization","IncomeRange",
               "TotalProsperLoans","LoanOriginalAmount", "Investors","ListingCreationDate",
               "Occupation","IsBorrowerHomeowner","BorrowerAPR","BorrowerRate",
               "Recommendations","DebtToIncomeRatio", "StatedMonthlyIncome")

# Keep only variables in colsToKeep (columns to keep)
prosperloans <- subset(pld, select=colsToKeep)

# Create new variable
prosperloans$LoanCreationYear <- format(as.Date(prosperloans$ListingCreationDate), "%Y")

# Filter out those who are > 120 days, defaulted or chargedoff to be considered delinquent
pl_defaulted <- subset(prosperloans, 
                        LoanStatus == "Defaulted" |
                        LoanStatus == "Chargedoff" |
                        LoanStatus == "Past Due (91-120 days)" |
                        LoanStatus == "Past Due (>120 days)")

# TODO: Create a new varible indicating delinquent 
# then i souldn't need pl_defaulted, just use new variable as flag??

str(prosperloans)
```

There are a few categorical features in the new dataset. At first glance, BorrowerState has 52 states or levels and Occupation has 68 levels/categories for over 113k observations - it should be possible to group by occupations to see any trends.

Example of categorical values in "LoanStatus"
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Review LoanStatus cateogories
levels(prosperloans$LoanStatus)
```

There are a few challenges here. If I'm investigating delinquencies, I need to define a definition for it, and since the Prosper data has a few categories that could cover this, I need to do two things 1) learn the difference between Chargedoff and Defaulted and 2) assign a cutoff line for delinquents, i.e if someone is 1-15 days late on payment is that delinquent? What about 61-90 days late?

Dictionary...

Chargedoff: 

Defaulted: 

Before going too far, I was curious as to the creation date distribution of observations in the dataset. This is important as this could cause bias in further investigation, for example, if the majority of the data was observed during 2008-2009 (the financial crisis) this could skew the data towards having a majority of delinquency. To analysis this I'm going to explore the ListingCreationDate feature along with LoanStatus.


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Investigate distribution of loan creation year
ggplot(prosperloans, aes(prosperloans$LoanCreationYear)) + 
  geom_bar()

# Review only delinquent borrowers looking for trends
ggplot(pl_defaulted, aes(pl_defaulted$LoanCreationYear, fill=pl_defaulted$LoanStatus)) + 
  geom_bar() +
  scale_fill_brewer(palette = "Blues")

```

Inorder to help faciliate this more easily, I've decided to create a new variable which will capture the year segment of the loan creation date.

Discuss - drop in 2009 and a steady pick up following subsequent years. Financial crisis??? No investors??? Competitors entered??? Need to review further. 

Looking at only delinqunet borrowers, a possible lead up to the financial crisis - using the same scale, no issues 2004/5, with increase in volume of defaults and chargedoff leading up to 2007/8 almost half of all borrowers

Remember - this is loan "creation" date, this is a good lesson in understanding the data and miss communication in visuals. This is not representing delinquent loans of 2007/8 but loans which went delinquent at some point in time that were created in 2007/8. I believe it can be assumed this is why you see a lead up to the financial crisis, i.e. borrowers took out loans at a "normal" rate from 2005-2008 but potentially after the financial crisis in 2008, borrowers can no longer pay and loans created 2006-2008 were the most succeptable to defaults. 

This assumption also explains the dip in 2009 and gradual increase, less borrowers (1st graph) and much fewer delinquents in comparison to the level of loans in good standing.

Time to further the analysis and some other interesting initial features to look at in regards to delinquency are: Term, LoanStatus, LoanOriginalAmount, Income Range, Borrower's State and Listing Category (the reason for a loan).

**Term and Loan Status**

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summary of loan terms
summary(prosperloans$Term)

# Plot loan terms
ggplot(prosperloans,aes(Term)) + 
  geom_bar(width = 12) +
  scale_x_continuous(breaks = c(0,12,36,60))

# Plot defaulted terms and their loan status distribution
ggplot(pl_defaulted,aes(Term, fill = LoanStatus)) + 
  geom_bar(width = 12) +
  scale_x_continuous(breaks = c(0,12,36,60)) + 
  scale_fill_brewer(palette = "Blues")
```

From the summary breakdown, the average term appears to be 36 months (3 yrs) with an original loan request being $8337, ranging from $1000 to 35000. This seems to cover the full available range allowed by Prosper, although at the time of writting this analysis, Prosper has a minimum limit of $2000. And what seems like a surprising amount, on average these loans have 80 investors.

It's also very clear that the majority of borrowers choose a 36 month term, where 60 and then 12 month terms are 2nd and 3rd most popular, respectively. And approximately 15% of the total borrowers are delinquent on their loans. And the distribution of delinquency is not surprisingly very similar to that of the total loan distribution across loan terms.

**Original Loan Amount**

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summary of loan terms
summary(prosperloans$LoanOriginalAmount)

# Plot loan terms
g <- ggplot(pl_defaulted,aes(LoanOriginalAmount))
g + geom_histogram(binwidth = 500)
```

Summary data indicates mean and median quite far apart. This is visualized in the graph which is right skewed graph. As it the spikes of borrowers at $10,000, $15,000 and $25,000 are pulling the mean higher. Although, it's not particularly surprising that borrowers gravitate to these "nice" numbers. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Zoom in to get details with reduced binwidth and added breaks
g + geom_histogram(binwidth = 100) + 
  scale_x_continuous(limits = c(500, 12000), 
                     breaks = c(1000,2000,3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000))
```

Zooming in to look at the details, specifically under $10,000, you can see multiple spikes at these "nice" numbers - 1000, 2000,...,8000, 9000, 10000 - dollars. Since most debt doesn't come in nice round numbers, we can assume borrowers are probably rounding up instead to requesting exact dollar values for their loans. For example, if a borrower is $4678.86 dollars in debt, she is probably requesting a loan of $5000.00. From the data provided, I don't believe there is in specific way to determine if this assumption is true, however, given that debt / money is a floating value with interest rate applied as floating value, it is quite unlikely that the majority of borrowers have debt divisible by 5.

**Income Range**

```{r}
# Plot out income range of delinquent borrowers
# Plot out income range of all borrowers

positions <- c("Not employed", "Not displayed", "$0", 
                "$1-24,999", "$25,000-49,999", "$50,000-74,999",
                "$75,000-99,999", "$100,000+")


ggplot(prosperloans, aes(IncomeRange)) + 
  scale_x_discrete(limits = positions) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_bar()

# TODO: Create a new varible indicating delinquent then use as fill = x for above plot
#ggplot(pl_defaulted, aes(IncomeRange)) + 
#  scale_x_discrete(limits = positions) +
#  geom_bar()

```

discuss

**Borrowers State**

```{r}
ggplot(prosperloans,aes(BorrowerState)) +
  geom_bar() +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Look at the top 10 states and show factors from LoanStatus

#TODO

#library(dplyr)
#f <- group_by(prosperloans,BorrowerState)
#summarize(f,count=n()) 
#arrange(f, desc(count))
```

Borrowers state covers 52 states, this includes DC and Puerto Rico. Representation for California is skewing the graph, unable to distinguish smaller state count and differences among states. Given California is the most populous state in the US, having a much higher count in borrowers is probably not a good indicator of a trend. To fix this and to better view any trend a log10 transformation was applied to the y axis.

borrowers state count/heatmap overlaid on country map using pl.defaulted
group borrowers state and summarize count by loan status

```{r}

# Map 2 letter abbrievation to full name for map plot
prosperloans$BorrowerStateFullName <- tolower(state.name[match(prosperloans$BorrowerState, state.abb)])

us <- map_data("state")

# need loanStatus to be their own varible with each region value totalled
# group by stateName, loanStatus factors 
grp_by_state <- prosperloans %>%
  group_by(BorrowerStateFullName, BorrowerState, LoanStatus) %>%
  summarise(count = n()) %>%
  filter(LoanStatus == "Defaulted" |
          LoanStatus == "Chargedoff" |
          LoanStatus == "Past Due (91-120 days)" |
          LoanStatus == "Past Due (>120 days)")

#TODO: clean this up + add abbr/labels
gg <- ggplot()
gg <- gg + geom_map(data = us, map = us,
                    aes(x = long, y = lat, map_id = region, label = region),
                    fill="#ffffff", color="#ffffff", size=0.15)
gg <- gg + geom_map(data = grp_by_state, map=us,
                    aes(fill = count, map_id = BorrowerStateFullName),
                    color = "#ffffff", size = 0.15)
gg <- gg + scale_fill_continuous(low='lightblue', high='darkblue', guide='colorbar')
gg <- gg + labs(x=NULL, y=NULL)
gg <- gg + coord_map("albers", lat0 = 39, lat1 = 45) 
gg <- gg + theme(panel.border = element_blank())
gg <- gg + theme(panel.background = element_blank())
gg <- gg + theme(axis.ticks = element_blank())
gg <- gg + theme(axis.text = element_blank())
gg

```

Discuss - count of delinquent borrowers across the US. CA has the highest levels but it should be taken into consideration that CA is the more populous. Middle of the America has the lowest rate of delinquency, East, West and Texas.

**Listing Category**

```{r}
# map numbers to category
listing_category <- c("Not Available", "Debt Consolidation", "Home Improvement", "Business",
                      "Personal Loan", "Student Use", "Auto", "Other", "Baby&Adoption",
                      "Boat", "Cosmetic Procedure", "Engagement Ring", "Green Loans",
                      "Household Expenses", "Large Purchases", "Medical/Dental", "Motorcycle",
                      "RV", "Taxes", "Vacation", "Wedding Loans")


prosperloans$ListingCategoryFullName <- listing_category[(prosperloans$ListingCategory..numeric.)+1]

ggplot(prosperloans, aes(prosperloans$ListingCategoryFullName)) +
  geom_bar() +
  scale_y_log10() + # consider including the log version as well
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Discuss

Unidentifable: Debt consolidation (could be a mix of anything), Not Available, Other, Business (maybe)...The next "real" answer is Auto and Home Improvement

The listing category values represent the purpose or reason why the borrower is requesting a loan. For example, if the value is "Auto", perhaps the borrower recently purchased an expensive car and needs $10,000 as a downpayment to lower her monthly bill.

In my observation with this plot is that, although "Debt Consolidation" is by far the most common reason borrowers require a loan, this is misleading. Debt consolidation removes the specificity of where the debt came from, i.e. Auto, Student Use, Taxes could have equally contributed to someone's debt but the "reason" the borrower is requesting a loan is for consolidation and therefore they flag "Debt Consolidation" as the purpose. One thing we can take away from the high volume of borrowers requesting debt consolidation loans, is that, many borrowers have debt from multiple sources. 


### Bivariate analysis
Continuing to look for trends in delinquency, I will investigate possible expected and unexpected relationships between features with scatterplot and by measuring thier coorelation (pearson / spearman / rho).

(?cor.test look for correlation)
xlim(0, quantile(data$col_name, 0.95)) get 95% of data along x and y

* listingCategory and loanOriginalAmount (need to map listing to values)
* bankcardUtilization and loanStatus
* borrowerRate and loanStatus
* loanStatus and investors (are you more likely to default if you have less investors? investors think you're a good bet to payoff your loan so more people invest in you. This would imply that having fewer investors mean people tend to believe you are a bad investment - more likely to default. Is this true?)


* Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?
* Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?
* What was the strongest relationship you found?

**listing cateogry and loan original amount**

loan amount for different categories. How to compare this with delinquent loans???
```{r}
g <- ggplot(prosperloans, aes(ListingCategoryFullName, LoanOriginalAmount, group = ListingCategoryFullName)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
g
```

Discuss - mean, debt consolidation outliers, max loan amount, baby/adoption and debt consolidation are surprising similar plots

**loan original amount and delinquent loans**

loan amount for delinquent borrowers and the number of delinquents
(x=amount, y=count of delinquents, filter by past due)

```{r}
g <- ggplot(prosperloans, aes(LoanOriginalAmount, Term)) +
  geom_point()
g
```


**Loan Term and Loan Amount**

```{r}
# boxplot
# look into outliers and discrete x axis on correct terms
g <- ggplot(prosperloans, aes(Term, LoanOriginalAmount, group = Term)) +
  geom_boxplot()
g
```


**Interest Rate and Listing Category**

Is there a relationship between what rate someone gets and their reason for a loan
```{r}
g <- ggplot(prosperloans, aes(ListingCategoryFullName, BorrowerRate, group = ListingCategoryFullName)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
g
```

Discuss - person loans has the lower mean APR, debt consolidation, boat and baby loans have similar mean APRs


**remember to bring it back to delinquency**

**loan and bankcard utilization**

```{r}
# laon, bankcard and loan status (factor)
ggplot(prosperloans, aes(LoanOriginalAmount, BankcardUtilization)) +
  geom_point() +
  scale_y_log10()
```

Discuss - over 7k borrowers with NA utilization and values over 1 (100% utilization) which I'm not sure how that was calculated. Even for lower loan amounts there is a high card utilization 


**Borrower Rate and APR**

```{r}
# useful in any way???
g <- ggplot(prosperloans, aes(BorrowerRate, BorrowerAPR)) +
  geom_point(alpha = 1/50)
g
```

Discuss - APR is annual cost of the loan to the Borrower, Rate is the interest rate to the borrower excluding fees.

**Debt-to-Income Ratio**

```{r}
# monthly income vs debt to income ratio
# relatioship between more monthly income and debt:income
p1 <- ggplot(prosperloans, aes(StatedMonthlyIncome, DebtToIncomeRatio)) +
  geom_point(alpha = 0.1) +
  scale_x_continuous(limits = c(0,20000)) +
  scale_y_continuous(limits = c(0, 1)) +
  geom_density2d()

p2 <- ggplot(pl_defaulted, aes(StatedMonthlyIncome, DebtToIncomeRatio)) +
  geom_point(alpha = 0.1) +
  scale_x_continuous(limits = c(0,20000)) +
  scale_y_continuous(limits = c(0, 1))

grid.arrange(p1, p2, nrow=1)
```

Discuss - at 20k a month, outliers with zero income and over 20k (approx 10k observations). Most borrower's debt-to-income ratio is under 0.25 (or 0.5). 

Look up "good", debt-to-income ratios

```{r}
# names(prosperloans)

ggplot(prosperloans, aes(BorrowerRate, DebtToIncomeRatio)) +
  geom_point(alpha = 0.1) +
  scale_y_log10()

```


### Multivariate Analysis

* Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?
* Were there any interesting or surprising interactions between features?
* OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

## Final Plots
### plot 1
description

### plot 2
description

### plot 3
description

## Reflection
stuff

### References
* https://en.wikipedia.org/wiki/Charge-off
* https://www.prosper.com/help/topics/how-to-read-a-loan-listing
* http://www.investopedia.com/terms/c/credit-utilization-rate.asp
* http://www.investopedia.com/terms/d/delinquent.asp
* http://docs.ggplot2.org
* http://zevross.com/blog/2014/08/04/beautiful-plotting-in-r-a-ggplot2-cheatsheet-3
* https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States
* http://stackoverflow.com/a/29618201/1343001
* http://www.investopedia.com/ask/answers/100314/what-difference-between-interest-rate-and-annual-percentage-rate-apr.asp

### Programming Environment
```{r}
sessionInfo()
```

